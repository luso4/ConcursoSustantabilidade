<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meu Site com QR Code</title>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f9;
    }
    header {
      background-color: #4CAF50;
      padding: 20px;
      color: white;
      text-align: center;
    }
    #scoreboard {
      margin: 20px;
      padding: 10px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    #scoreboard div {
      padding: 10px;
      border-bottom: 1px solid #eee;
    }
    #scoreboard div:last-child {
      border-bottom: none;
    }
    #scanQRCodeButton {
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 20px;
    }
    #scanQRCodeButton:hover {
      background-color: #45a049;
    }
    #video {
      display: none;
      width: 100%;
      height: auto;
    }
    canvas {
      display: none;
    }
  </style>
</head>
<body>

  <header>
    <h1>Bem-vindo ao Sistema de Pontuação</h1>
  </header>

  <!-- Scoreboard Section -->
  <section>
    <h2>Scoreboard</h2>
    <div id="scoreboard">
      <!-- Os dados do scoreboard serão carregados aqui -->
    </div>
  </section>

  <!-- Botão para Ativar a Câmera -->
  <button id="scanQRCodeButton">Ativar Câmera e Ler QR Code</button>

  <!-- Câmera para escanear QR Code -->
  <video id="video" width="300" height="300"></video>
  <canvas id="canvas"></canvas>

  <script>
    // Função para carregar o scoreboard do back-end e exibir na página
    function carregarScoreboard() {
      fetch('http://localhost:5000/scoreboard')
        .then(response => response.json())
        .then(data => {
          const scoreboardDiv = document.getElementById('scoreboard');
          scoreboardDiv.innerHTML = ''; // Limpar conteúdo anterior
          
          data.forEach(jogador => {
            const jogadorDiv = document.createElement('div');
            jogadorDiv.textContent = `${jogador.nome}: ${jogador.pontos} pontos`;
            scoreboardDiv.appendChild(jogadorDiv);
          });
        })
        .catch(error => {
          console.error('Erro ao carregar o scoreboard:', error);
        });
    }

    // Chama a função para carregar o scoreboard assim que a página for carregada
    window.onload = carregarScoreboard;

    // Ativar a câmera do celular para escanear QR Code
    document.getElementById('scanQRCodeButton').addEventListener('click', function() {
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const context = canvas.getContext('2d');
      video.style.display = 'block';

      // Acessar a câmera do dispositivo
      navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(function(stream) {
          video.srcObject = stream;
          video.play();
          // Detectar QR Code periodicamente
          detectarQRCode(video, canvas, context);
        })
        .catch(function(error) {
          console.error('Erro ao acessar a câmera: ', error);
        });
    });

    // Variável global para armazenar o score dos jogadores
    let scoreboard = [
        { nome: "Jogador 1", pontos: 150 },
        { nome: "Jogador 2", pontos: 120 }
    ];

    function detectarQRCode(video, canvas, context) {
    setInterval(function() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
        // Atualiza o canvas com o conteúdo do vídeo
        canvas.height = video.videoHeight;
        canvas.width = video.videoWidth;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        // Lê os dados da imagem do canvas
        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
        const qrCode = jsQR(imageData.data, canvas.width, canvas.height);

        if (qrCode) {
            // Quando um QR Code for detectado, mostra o conteúdo
            console.log('QR Code detectado: ' + qrCode.data); // Log apenas para depuração

            // Verifica se o QR Code é igual a um valor específico
            if (qrCode.data === 'https://qrco.de/bfm6Ip') {
            // Encontrou o QR Code correto - adiciona 10 pontos ao Jogador 1
            addPoints("Jogador 1", 10);
        }
        
        // Aqui você pode verificar outros QR Codes, se necessário
        // Exemplo:
        // else if (qrCode.data === 'outro-codigo') {
        //   addPoints("Jogador 2", 10);
        // }

        // Fechar a câmera após ler o QR Code
        video.srcObject.getTracks().forEach(track => track.stop());
        video.style.display = 'none';
        }
        }
    }, 100); // Checa a cada 100ms
    }

    // Função para adicionar pontos ao jogador
    function addPoints(nomeJogador, pontos) {
        // Encontra o jogador pelo nome e adiciona os pontos
        const jogador = scoreboard.find(jogador => jogador.nome === nomeJogador);
        if (jogador) {
            jogador.pontos += pontos; // Adiciona os pontos
            console.log(`${nomeJogador} agora tem ${jogador.pontos} pontos.`);
            atualizarScoreboard(); // Atualiza a interface com o novo score
        }
    }

        // Função para atualizar o scoreboard na página
        function atualizarScoreboard() {
        const scoreboardDiv = document.getElementById('scoreboard');
        scoreboardDiv.innerHTML = ''; // Limpar conteúdo anterior
  
        // Adicionar os jogadores e seus pontos ao scoreboard
        scoreboard.forEach(jogador => {
        const jogadorDiv = document.createElement('div');
        jogadorDiv.textContent = `${jogador.nome}: ${jogador.pontos} pontos`;
        scoreboardDiv.appendChild(jogadorDiv);
    });
    }

  </script>
</body>
</html>
